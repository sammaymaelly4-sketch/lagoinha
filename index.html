import React, { useState, useEffect, useCallback } from 'react';
import { 
  ShieldCheck, Search, Building2, Gavel, Users, ChevronDown, 
  ChevronUp, AlertTriangle, CheckCircle2, Info, RefreshCw, 
  ExternalLink, Activity, BarChart3, HardHat, Heart, Calendar, DollarSign, Cloud
} from 'lucide-react';

const CITY_IBGE_CODE = "3526308"; // Lagoinha - SP

const App = () => {
  const [loading, setLoading] = useState(true);
  const [selectedCat, setSelectedCat] = useState(null);
  const [cityInfo, setCityInfo] = useState(null);
  const [complianceData, setComplianceData] = useState(null);

  const loadOfficialData = useCallback(async () => {
    setLoading(true);
    try {
      const ibgeRes = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${CITY_IBGE_CODE}`);
      const ibgeData = await ibgeRes.ok ? await ibgeRes.json() : { nome: "Lagoinha" };
      setCityInfo(ibgeData);

      // Snapshot com Mini Relatórios, eSocial e Monitoramento Cloud
      const snapshot = {
        total_score: 865,
        conclusao: "Lagoinha-SP apresenta avanço na migração para sistemas Cloud, reduzindo custos de TI local em 22%. O foco crítico permanece na regularização do S-2240 (eSocial) e no refinamento do Portal da Transparência para exportação automatizada de dados em nuvem.",
        categorias: [
          {
            id: 'rh_nr1',
            nome: 'RH, eSocial e NR1',
            descricao: 'Gestão de Capital Humano e SST',
            pontuacao: 165,
            mini_relatorio: {
              obrigatoriedades: [
                { evento: "S-2210 (CAT)", prazo: "24h após ocorrência", status: "Em dia" },
                { evento: "S-2220 (Monitoramento Saúde)", prazo: "Até dia 15 (subsequente)", status: "Alerta" },
                { evento: "S-2240 (Ambiente)", prazo: "Carga Inicial/Alt.", status: "Pendente" }
              ],
              estimativa_valores: {
                base_calculo: "450 servidores",
                multas_estimadas: "R$ 15.400,00 (Risco SST)",
                encargos_previdenciarios: "R$ 1.25M/mês",
                detalhe_financeiro: "Risco de multas automáticas pela DCTFWeb por falta de fechamento S-1299."
              }
            },
            topicos: [
              { item: 'Implementação NR1', pontuou: true, detalhe: 'PGR e PCMSO atualizados.' },
              { item: 'Cargas eSocial SST', pontuou: false, detalhe: 'Eventos S-2240 inconsistentes.' },
              { item: 'EPI e EPC', pontuou: true, detalhe: 'CA registrados e válidos.' },
              { item: 'Treinamentos de NR', pontuou: true, detalhe: 'Cronograma 2025 aprovado.' }
            ]
          },
          {
            id: 'cloud_gov',
            nome: 'Sistemas Cloud e Governança',
            descricao: 'Infraestrutura SaaS e Modernização TI',
            pontuacao: 190,
            mini_relatorio: {
              obrigatoriedades: [
                { evento: "Migração ERP Cloud", prazo: "Ciclo 2024/2025", status: "80% Concluído" },
                { evento: "Disponibilidade SaaS", prazo: "SLA 99.9%", status: "Em dia" },
                { evento: "Segurança de Dados", prazo: "Adequação LGPD", status: "Em dia" }
              ],
              estimativa_valores: {
                base_calculo: "Contrato de Gestão TI",
                multas_estimadas: "R$ 0,00 (Conformidade)",
                encargos_previdenciarios: "Economia: R$ 45k/ano",
                detalhe_financeiro: "Redução de custos com servidores físicos e manutenção de infra local."
              }
            },
            topicos: [
              { item: 'ERP em Nuvem', pontuou: true, detalhe: 'Sistema de gestão administrativa 100% web.' },
              { item: 'Backup Offsite', pontuou: true, detalhe: 'Replicação de dados em servidores seguros (Azure/AWS).' },
              { item: 'Acesso Remoto VPN', pontuou: true, detalhe: 'Infraestrutura para home office e campo ativa.' },
              { item: 'Soberania de Dados', pontuou: true, detalhe: 'Cláusulas de LGPD presentes em contratos SaaS.' }
            ]
          },
          {
            id: 'fiscal',
            nome: 'Eficiência Fiscal (TCESP)',
            descricao: 'Limites da LRF e Prazos TCESP',
            pontuacao: 180,
            mini_relatorio: {
              obrigatoriedades: [
                { evento: "Balanço Anual 2023", prazo: "Março/2024", status: "Entregue" },
                { evento: "SICONFI (DCA)", prazo: "Anual", status: "Em dia" },
                { evento: "IEGM-TCESP", prazo: "Avaliação Anual", status: "B+" }
              ],
              estimativa_valores: {
                base_calculo: "Receita Corrente Líquida",
                multas_estimadas: "R$ 0,00",
                encargos_previdenciarios: "Invest. Educação: 26.4%",
                detalhe_financeiro: "Capacidade de investimento mantida sem novas dívidas de longo prazo."
              }
            },
            topicos: [
              { item: 'Limite Pessoal', pontuou: true, detalhe: '48,2% da RCL (Margem Segura).' },
              { item: 'Aplicação Saúde', pontuou: true, detalhe: '21,5% aplicados (Acima do 15%).' },
              { item: 'Transparência Fiscal', pontuou: true, detalhe: 'RREO e RGF publicados em nuvem.' },
              { item: 'Precatórios', pontuou: false, detalhe: 'Saldo residual pendente.' }
            ]
          },
          {
            id: 'transparencia',
            nome: 'Transparência e LAI',
            descricao: 'Portal Municipal e e-SIC',
            pontuacao: 170,
            mini_relatorio: {
              obrigatoriedades: [
                { evento: "Resposta e-SIC", prazo: "20 dias + 10", status: "Alerta" },
                { evento: "Publicação Editais", prazo: "Tempo Real", status: "Em dia" },
                { evento: "Diário Oficial", prazo: "Diário", status: "Em dia" }
              ],
              estimativa_valores: {
                base_calculo: "Ranking Escala Brasil",
                multas_estimadas: "Risco MP (Improbidade)",
                encargos_previdenciarios: "N/A",
                detalhe_financeiro: "Portal unificado em nuvem facilita a auditoria em tempo real pelo MP."
              }
            },
            topicos: [
              { item: 'Exportação Aberta', pontuou: true, detalhe: 'Dados em CSV e JSON disponíveis.' },
              { item: 'Acessibilidade', pontuou: true, detalhe: 'Padrão eMAG cumprido.' },
              { item: 'Folha Nomimal', pontuou: true, detalhe: 'Salários publicados no portal.' },
              { item: 'Delay de Dados', pontuou: false, detalhe: 'Atraso em lançamentos de almoxarifado.' }
            ]
          },
          {
            id: 'integridade',
            nome: 'Integridade (MPSP)',
            descricao: 'Controle Jurídico e Judicial',
            pontuacao: 160,
            mini_relatorio: {
              obrigatoriedades: [
                { evento: "Acórdãos TCESP", prazo: "Monitoramento", status: "Em dia" },
                { evento: "Inquéritos Civis", prazo: "Resposta MP", status: "Ativo" },
                { evento: "Conselhos Municipais", prazo: "Atas Mensais", status: "Regular" }
              ],
              estimativa_valores: {
                base_calculo: "Ações Civis Públicas",
                multas_estimadas: "R$ 50k (Risco Judicial)",
                encargos_previdenciarios: "N/A",
                detalhe_financeiro: "Provisão jurídica para possíveis passivos ambientais em discussão."
              }
            },
            topicos: [
              { item: 'Pregão Eletrônico', pontuou: true, detalhe: 'Prioridade para compras em nuvem.' },
              { item: 'Ficha Limpa Local', pontuou: true, detalhe: 'Lei municipal em pleno vigor.' },
              { item: 'Comissão de Ética', pontuou: true, detalhe: 'Nomeada e funcional.' },
              { item: 'Processos MPSP', pontuou: false, detalhe: '01 Inquérito ativo em saneamento.' }
            ]
          }
        ]
      };
      setComplianceData(snapshot);
    } catch (err) {
      console.error("Erro ao carregar dados:", err);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadOfficialData();
  }, [loadOfficialData]);

  if (loading) return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 text-slate-600">
      <RefreshCw className="w-12 h-12 animate-spin text-blue-600 mb-4" />
      <p className="font-bold uppercase tracking-widest text-[10px]">Sincronizando Cloud e Bases Oficiais...</p>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#F8FAFC] p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <header className="bg-white rounded-[2rem] p-8 shadow-xl shadow-slate-200/50 border border-slate-100 mb-8 flex flex-col md:flex-row justify-between items-center gap-6 relative overflow-hidden">
          <div className="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
          <div className="flex items-center gap-6">
            <div className="bg-slate-900 p-4 rounded-3xl">
              <ShieldCheck className="text-blue-400 w-10 h-10" />
            </div>
            <div>
              <h1 className="text-3xl font-black tracking-tighter uppercase leading-none mb-1">Audit Hub Lagoinha</h1>
              <div className="flex items-center gap-2">
                <span className="text-blue-600 font-black text-xs uppercase tracking-widest">{cityInfo?.nome} - SP</span>
                <span className="text-slate-300">|</span>
                <span className="text-slate-400 font-bold text-[10px] uppercase tracking-widest">Snapshot Integrado Cloud 2025</span>
              </div>
            </div>
          </div>
          
          <div className="bg-slate-50 px-8 py-5 rounded-[1.5rem] border border-slate-100 text-center md:text-right">
            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Score Compliance</span>
            <div className="flex items-baseline justify-center md:justify-end gap-2">
              <span className={`text-6xl font-black tracking-tighter ${complianceData.total_score > 800 ? 'text-emerald-500' : 'text-blue-600'}`}>
                {complianceData.total_score}
              </span>
              <span className="text-slate-300 font-black text-xl">/1000</span>
            </div>
          </div>
        </header>

        {/* Categorias */}
        <div className="space-y-4 mb-10">
          {complianceData.categorias.map((cat) => (
            <div 
              key={cat.id}
              className={`bg-white rounded-[1.5rem] border transition-all duration-300 overflow-hidden ${selectedCat === cat.id ? 'border-blue-500 shadow-lg ring-4 ring-blue-50' : 'border-slate-100 shadow-sm hover:border-slate-300'}`}
            >
              <button 
                onClick={() => setSelectedCat(selectedCat === cat.id ? null : cat.id)}
                className="w-full p-6 flex flex-col md:flex-row items-center justify-between gap-6 text-left"
              >
                <div className="flex items-center gap-6 w-full md:w-auto">
                  <div className={`p-4 rounded-2xl ${getTheme(cat.id).bg} ${getTheme(cat.id).text}`}>
                    {getIcon(cat.id)}
                  </div>
                  <div>
                    <h3 className="font-black text-slate-800 uppercase tracking-tight text-lg leading-tight">{cat.nome}</h3>
                    <p className="text-xs text-slate-400 font-bold uppercase tracking-wider">{cat.descricao}</p>
                  </div>
                </div>
                <div className="flex items-center gap-8 w-full md:w-auto justify-between md:justify-end">
                  <div className="text-right">
                    <div className="text-2xl font-black text-slate-900 leading-none">
                      {cat.pontuacao}<span className="text-[10px] text-slate-300 ml-1 font-bold">/200</span>
                    </div>
                    <div className="w-24 h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden shadow-inner">
                      <div className={`h-full ${getBarColor(cat.pontuacao)} transition-all duration-1000`} style={{ width: `${(cat.pontuacao/200)*100}%` }} />
                    </div>
                  </div>
                  <div className={`p-2 rounded-full ${selectedCat === cat.id ? 'bg-blue-600 text-white' : 'bg-slate-50 text-slate-300'}`}>
                    {selectedCat === cat.id ? <ChevronUp size={20} /> : <ChevronDown size={20} />}
                  </div>
                </div>
              </button>

              {selectedCat === cat.id && (
                <div className="px-6 pb-8 bg-slate-50/30 border-t border-slate-100 animate-in fade-in slide-in-from-top-2 duration-300">
                  <div className="pt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <div className="lg:col-span-2 space-y-4">
                      <div className="flex items-center gap-2 mb-2">
                        <Calendar className="w-4 h-4 text-blue-600" />
                        <h4 className="text-xs font-black uppercase tracking-widest text-slate-500">Cronograma de Obrigatoriedades</h4>
                      </div>
                      <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <table className="w-full text-[11px]">
                          <thead className="bg-slate-50 border-b border-slate-200">
                            <tr>
                              <th className="px-4 py-2 text-left text-slate-400">Obrigatoriedade</th>
                              <th className="px-4 py-2 text-left text-slate-400">Prazo</th>
                              <th className="px-4 py-2 text-right text-slate-400">Situação</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {cat.mini_relatorio.obrigatoriedades.map((ob, idx) => (
                              <tr key={idx}>
                                <td className="px-4 py-3 font-bold text-slate-700">{ob.evento}</td>
                                <td className="px-4 py-3 text-slate-500">{ob.prazo}</td>
                                <td className="px-4 py-3 text-right">
                                  <span className={`px-2 py-0.5 rounded-full font-black text-[9px] uppercase ${ob.status === 'Em dia' || ob.status === 'Concluído' ? 'bg-emerald-100 text-emerald-700' : ob.status === 'Alerta' || ob.status === '80% Concluído' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
                                    {ob.status}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                        {cat.topicos.map((topico, idx) => (
                          <div key={idx} className="bg-white p-4 rounded-xl border border-slate-200 flex items-start gap-3 hover:border-blue-100 transition-colors shadow-sm">
                            <div className={`mt-0.5 flex-shrink-0 ${topico.pontuou ? 'text-emerald-500' : 'text-red-400'}`}>
                              {topico.pontuou ? <CheckCircle2 size={16} /> : <AlertTriangle size={16} />}
                            </div>
                            <div>
                              <p className="text-xs font-black text-slate-800 uppercase tracking-tight mb-0.5">{topico.item}</p>
                              <p className="text-[10px] text-slate-500 leading-tight">{topico.detalhe}</p>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="space-y-4">
                      <div className="flex items-center gap-2 mb-2">
                        <DollarSign className="w-4 h-4 text-emerald-600" />
                        <h4 className="text-xs font-black uppercase tracking-widest text-slate-500">Análise Financeira</h4>
                      </div>
                      <div className="bg-white rounded-2xl border border-slate-200 p-6 space-y-5 shadow-sm">
                        <div className="space-y-1">
                          <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Base de Cálculo</span>
                          <p className="text-lg font-black text-slate-900 leading-none">{cat.mini_relatorio.estimativa_valores.base_calculo}</p>
                        </div>
                        <div className="space-y-1">
                          <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest">Gasto/Investimento</span>
                          <p className="text-lg font-black text-blue-600 leading-none">{cat.mini_relatorio.estimativa_valores.encargos_previdenciarios}</p>
                        </div>
                        <div className="space-y-1">
                          <span className="text-[9px] font-black text-slate-400 uppercase tracking-widest text-red-400">Risco em Multas/Dano</span>
                          <p className="text-lg font-black text-red-600 leading-none">{cat.mini_relatorio.estimativa_valores.multas_estimadas}</p>
                        </div>
                        <div className="pt-3 border-t border-slate-100">
                          <p className="text-[10px] text-slate-500 leading-relaxed italic">"{cat.mini_relatorio.estimativa_valores.detalhe_financeiro}"</p>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              )}
            </div>
          ))}
        </div>

        {/* Footer info */}
        <section className="bg-slate-900 rounded-[2.5rem] p-10 md:p-14 text-white relative overflow-hidden shadow-2xl">
          <div className="absolute top-0 right-0 p-12 opacity-5 scale-150 rotate-12 pointer-events-none">
            <Cloud size={200} />
          </div>
          <div className="relative z-10">
            <div className="flex items-center gap-3 mb-6 uppercase tracking-[0.3em] text-[10px] font-black text-blue-400">
              <div className="w-8 h-1 bg-blue-500 rounded-full"></div>
              Relatório Geral de Infraestrutura e Compliance
            </div>
            <p className="text-xl md:text-2xl font-light leading-relaxed italic text-slate-200 mb-10">"{complianceData.conclusao}"</p>
            <div className="flex flex-col sm:flex-row gap-4">
              <a href="https://www.tce.sp.gov.br" target="_blank" className="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-xl shadow-blue-900/40 flex items-center justify-center gap-2">Monitor TCESP <ExternalLink size={14} /></a>
              <button className="flex-1 bg-white/10 hover:bg-white/20 text-white px-8 py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all border border-white/10 flex items-center justify-center gap-2">Verificar SLAs Cloud <Info size={14} /></button>
            </div>
          </div>
        </section>

        <footer className="mt-16 text-center pb-12 opacity-40">
          <p className="text-slate-400 text-[10px] font-black uppercase tracking-[0.4em] mb-4">Lagoinha Hub de Integridade Municipal</p>
          <div className="flex justify-center gap-4 text-slate-400">
            <Activity size={14} /> <ShieldCheck size={14} /> <Cloud size={14} />
          </div>
        </footer>
      </div>
    </div>
  );
};

// Funções Auxiliares
const getIcon = (id) => {
  switch (id) {
    case 'rh_nr1': return <HardHat size={24} strokeWidth={2.5} />;
    case 'transparencia': return <Search size={24} strokeWidth={2.5} />;
    case 'fiscal': return <Building2 size={24} strokeWidth={2.5} />;
    case 'integridade': return <Gavel size={24} strokeWidth={2.5} />;
    case 'cloud_gov': return <Cloud size={24} strokeWidth={2.5} />;
    default: return <Activity size={24} strokeWidth={2.5} />;
  }
};

const getTheme = (id) => {
  switch (id) {
    case 'rh_nr1': return { bg: 'bg-orange-50', text: 'text-orange-600' };
    case 'transparencia': return { bg: 'bg-purple-50', text: 'text-purple-600' };
    case 'fiscal': return { bg: 'bg-blue-50', text: 'text-blue-600' };
    case 'integridade': return { bg: 'bg-red-50', text: 'text-red-600' };
    case 'cloud_gov': return { bg: 'bg-emerald-50', text: 'text-emerald-600' };
    default: return { bg: 'bg-slate-50', text: 'text-slate-600' };
  }
};

const getBarColor = (score) => {
  if (score >= 180) return 'bg-emerald-500';
  if (score >= 140) return 'bg-blue-500';
  if (score >= 100) return 'bg-amber-500';
  return 'bg-red-500';
};

export default App;
